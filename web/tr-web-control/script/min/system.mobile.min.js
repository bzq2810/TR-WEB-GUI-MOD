/*! transmission-web-control 2017-09-29 */

var system={version:"1.1 Beta",rootPath:"tr-web-control/",codeupdate:"20170317",config:{autoReload:!0,reloadStep:5e3,pageSize:30,defaultSelectNode:null},lang:null,reloading:!1,autoReloadTimer:null,downloadDir:"",islocal:!1,B64:new Base64,currentTorrentId:0,currentContentPage:"home",currentContentConfig:null,control:{tree:null,torrentlist:null},serverConfig:null,serverSessionStats:null,torrentListChecked:!1,debug:function(a,b){window.console&&window.console.log&&window.console.log(a,b)},setlang:function(a,b){a||(a=this.config.defaultLang?this.config.defaultLang:navigator.language||navigator.browserLanguage),a||(a="zh-CN"),-1!=a.indexOf("-")&&(a=a.split("-")[0].toLocaleLowerCase()+"-"+a.split("-")[1].toLocaleUpperCase()),this.languages[a]||(a="en"),$.getScript(system.rootPath+"lang/"+a+".js",function(){system.lang=$.extend(!0,system.defaultLang,system.lang),system.resetLangText(),b&&b()})},resetLangText:function(){var items=$("*[system-lang]");$.each(items,function(key,item){var name=$(item).attr("system-lang");$(item).html(eval("system.lang."+name))})},init:function(a,b){this.readConfig(),transmission.options.getFolders=!1,null==this.lang?this.setlang(a,function(){system.initdata()}):this.initdata()},initdata:function(){$(document).attr("title",this.lang.system.title+" "+this.version),this.control.torrentlist=$("#torrent-list"),this.connect()},readConfig:function(){var a=cookies.get("transmission-web-control");$.isPlainObject(a)&&(this.config=$.extend(this.config,a))},saveConfig:function(){cookies.set("transmission-web-control",this.config,100)},connect:function(){transmission.on.torrentCountChange=function(){system.reloadTorrentBaseInfos()},transmission.on.postError=function(){},transmission.init({islocal:!0},function(){system.reloadSession(!0),system.getServerStatus()})},reloadSession:function(a){transmission.getSession(function(a){system.serverConfig=a,1==a["alt-speed-enabled"]?$("#status_alt_speed").show():$("#status_alt_speed").hide(),system.downloadDir=a["download-dir"],parseInt(system.serverConfig["rpc-version"])>=15?transmission.getFreeSpace(system.downloadDir,function(a){system.serverConfig["download-dir-free-space"]=a.arguments["size-bytes"],system.showFreeSpace(a.arguments["size-bytes"])}):system.showFreeSpace(system.serverConfig["download-dir-free-space"])})},showFreeSpace:function(a){var b=a;b=-1==b?system.lang.public["text-unknown"]:formatSize(b),$("#status_freespace").text(b)},getServerStatus:function(){this.reloading||(clearTimeout(this.autoReloadTimer),this.reloading=!0,transmission.getStatus(function(a){system.reloading=!1,$("#status_downloadspeed").html(formatSize(a.downloadSpeed,!1,"speed")),$("#status_uploadspeed").html(formatSize(a.uploadSpeed,!1,"speed")),system.serverSessionStats=a}))},reloadTorrentBaseInfos:function(a){if(!this.reloading){clearTimeout(this.autoReloadTimer),this.reloading=!0;var b={trackers:transmission.trackers,folders:transmission.torrents.folders};transmission.torrents.getallids(function(a){var c=new Array;for(var d in a){var e=a[d];c.push(e.id)}var f=transmission.torrents.getErrorIds(c,!0);f.length>0?transmission.torrents.getallids(function(){system.resetTorrentInfos(b)},f):system.resetTorrentInfos(b)},a)}},resetTorrentInfos:function(a){this.currentTorrentId;if(transmission.torrents.status[transmission._status.stopped]?this.updateCount("paused",transmission.torrents.status[transmission._status.stopped].length):this.updateCount("paused",0),transmission.torrents.status[transmission._status.seed]?this.updateCount("sending",transmission.torrents.status[transmission._status.seed].length):this.updateCount("sending",0),transmission.torrents.status[transmission._status.check]?this.updateCount("check",transmission.torrents.status[transmission._status.check].length):this.updateCount("check",0),transmission.torrents.status[transmission._status.download]?this.updateCount("downloading",transmission.torrents.status[transmission._status.download].length):this.updateCount("downloading",0),this.updateCount("actively",transmission.torrents.actively.length),this.updateCount("error",transmission.torrents.error.length),this.updateCount("warning",transmission.torrents.warning.length),system.reloading=!1,system.config.autoReload&&(system.autoReloadTimer=setTimeout(function(){system.reloadData()},system.config.reloadStep)),this.updateCount("all",transmission.torrents.count),"torrent-list"==this.currentContentPage){var b=this.currentContentConfig;b.reload=!0,this.showContent(b)}},updateCount:function(a,b){var c=$("#count-"+a);c.text(b),0==b?c.hide():c.show()},reloadData:function(){this.reloadSession(),this.reloading=!1,this.getServerStatus(),this.reloading=!1,this.reloadTorrentBaseInfos()},showContent:function(a){var b={page:"",type:"",data:"",title:this.lang.system.title,reload:!1,callback:null},c=null;if("string"==typeof a?(b.page=a,c=b):c=jQuery.extend(b,a),c.page!=this.currentContentPage||c.reload){switch($("#content-"+c.page).show(),c.page!=this.currentContentPage&&($("#content-"+this.currentContentPage).hide(),this.control.torrentlist.find("input:checked").prop("checked",!1).checkboxradio("refresh"),this.torrentListChecked=!1),$("#torrent-page-bar").hide(),this.torrentListChecked||$("#torrent-toolbar").hide(),this.currentContentPage=c.page,c.type){case"torrent-list":c.title=this.lang.tree[c.data],this.loadTorrentToList({target:c.data})}$("#page-title").text(c.title),c.reload=!1,this.currentContentConfig=c,c.callback&&c.callback()}},getTorrentFromType:function(a){var b=null;switch(a){case"torrent-all":case"all":case"servers":b=transmission.torrents.all;break;case"paused":b=transmission.torrents.status[transmission._status.stopped];break;case"sending":b=transmission.torrents.status[transmission._status.seed];break;case"seedwait":b=transmission.torrents.status[transmission._status.seedwait];break;case"check":b=transmission.torrents.status[transmission._status.check];break;case"checkwait":b=transmission.torrents.status[transmission._status.checkwait];break;case"downloading":b=transmission.torrents.status[transmission._status.download];break;case"downloadwait":b=transmission.torrents.status[transmission._status.downloadwait];break;case"actively":b=transmission.torrents.actively;break;case"error":b=transmission.torrents.error;break;case"warning":b=transmission.torrents.warning;break;case"search-result":b=transmission.torrents.searchResult}return b},loadTorrentToList:function(a){if(!this.torrentListChecked&&transmission.torrents.all){var b={node:null,page:1,target:"all"};if(jQuery.extend(b,a),a.target){var c=this.getTorrentFromType(a.target);this.config.defaultSelectNode=a.target,this.saveConfig();var d=new Array;this.control.torrentlist.empty();for(var e in c)if(c[e]){var f=parseFloat(100*c[e].percentDone).toFixed(2),g=this.lang.torrent["status-text"][c[e].status];0!=c[e].error?g="<span class='text-status-error'>"+g+"</span>":c[e].warning&&(g="<span class='text-status-warning' title='"+c[e].warning+"'>"+g+"</span>");var h={id:c[e].id,name:this.getTorrentNameBar(c[e]),totalSize:c[e].totalSize,percentDone:this.getTorrentProgressBar(f,c[e]),percentDoneNumber:f,status:g,addedDate:formatLongTime(c[e].addedDate),completeSize:c[e].totalSize-c[e].leftUntilDone,rateDownload:c[e].rateDownload,rateUpload:c[e].rateUpload,leecherCount:c[e].leecher,seederCount:c[e].seeder,uploadRatio:c[e].uploadRatio,uploadedEver:c[e].uploadedEver};d.push(h)}if(0==d.length)return void setTimeout(function(){system.showContent("home")},100);null==this.torrentPager.onGotoPage&&(this.torrentPager.onGotoPage=function(a){system.control.torrentlist.empty(),$("#torrent-toolbar").hide();for(var b in a)system.appendTorrentToList(a[b]);$(system.control.torrentlist).listview("refresh").find("input[type='checkbox']").click(function(){system.changeTorrentToolbar(this,h),system.torrentListChecked,system.control.torrentlist.find("a[name='torrent']").css("marginLeft","0px")}).checkboxradio()}),this.torrentPager.setDatas(d,a.target)}}},appendTorrentToList:function(a){var b={id:a.id,name:a.name,rateDownload:formatSize(a.rateDownload,!1,"speed"),rateUpload:formatSize(a.rateUpload,!1,"speed"),completeSize:formatSize(a.completeSize),totalSize:formatSize(a.totalSize),percentDone:a.percentDone},c="<li id='li-torrent-$id$' torrentid='$id$' style='padding:0px;'><a name='torrent' style='padding:0px;margin-left:0px;'><label data-corners='false' style='margin:0px;border:0px;padding:0px;'><input type='checkbox' id='torrent-$id$'/><label for='torrent-$id$'><h3 style='margin:0px;'>$name$</h3><div style='padding:0px 10px 5px 0px;'>$percentDone$</div><p class='torrent-list-infos'>↓$rateDownload$ ↑$rateUpload$|$completeSize$/$totalSize$</p></label></label></a><a class='more'></a>";c=c.replace(/\$([^\$]*)\$/g,function(a,c){return b[c]});var d=$(c);d.on("swiperight",function(a){system.control.torrentlist.find("a[name='torrent']").css("marginLeft","0px")}),d.on("swipeleft",function(a){system.control.torrentlist.find("a[name='torrent']").css("marginLeft","0px")}),d.appendTo(this.control.torrentlist)},getTorrentNameBar:function(a){var b="",c=a.name;switch(a.status){case transmission._status.stopped:b="iconlabel icon-pause-small";break;case transmission._status.check:b="iconlabel icon-checking";break;case transmission._status.download:b="iconlabel icon-down";break;case transmission._status.seed:b="iconlabel icon-up";break;case transmission._status.seedwait:case transmission._status.downloadwait:case transmission._status.checkwait:b="iconlabel icon-wait"}return a.warning&&(b="iconlabel icon-warning-type1",c+="\n\n"+this.lang.public["text-info"]+": "+a.warning),0!=a.error&&(b="iconlabel icon-exclamation",c+="\n\n"+this.lang.public["text-info"]+": "+a.errorString),'<span class="'+b+'" title="'+c+'">'+a.name+"</span>"},getTorrentProgressBar:function(a,b){a+="%";var c="";switch(b.status){case transmission._status.stopped:c="torrent-progress-stop";break;case transmission._status.checkwait:case transmission._status.check:c="torrent-progress-check";break;case transmission._status.downloadwait:case transmission._status.download:c="torrent-progress-download";break;case transmission._status.seedwait:case transmission._status.seed:c="torrent-progress-seed"}return b.warning&&(c="torrent-progress-warning"),0!=b.error&&(c="torrent-progress-error"),'<div class="torrent-progress" title="'+a+'"><div class="torrent-progress-text">'+a+'</div><div class="torrent-progress-bar '+c+'" style="width:'+a+';"></div></div>'},changeTorrentToolbar:function(a,b){var c=this.control.torrentlist.find("input:checked");$("#torrent-checked-count").html(c.length),c.length>0?(this.torrentListChecked=!0,$("#torrent-toolbar").show()):(this.torrentListChecked=!1,$("#torrent-toolbar").hide()),b&&(this.currentTorrentId=b.id)},torrentPager:{datas:null,pageSize:30,pageNumber:0,pageCount:0,count:0,onGotoPage:null,currentDatas:null,pageBar:null,controls:{prev:null,next:null,number:null},head:"",init:function(a){this.pageBar=$("#torrent-page-bar"),this.controls.next=this.pageBar.find("#page-next"),this.controls.next.click(function(){system.torrentPager.gotoPage("next")}),this.controls.prev=this.pageBar.find("#page-prev"),this.controls.prev.click(function(){system.torrentPager.gotoPage("prev")}),this.controls.number=this.pageBar.find("#page-number"),a&&this.setDatas(a)},setDatas:function(a,b){this.datas||this.init(),this.datas=a,this.pageBar.show(),this.count=this.datas.length,this.pageCount=parseInt(this.count/this.pageSize),this.count%this.pageSize>0&&this.pageCount++,1==this.pageCount&&this.pageBar.hide(),this.head==b?this.gotoPage():this.gotoPage(1),this.head=b},gotoPage:function(a){if("number"==typeof a)this.pageNumber=a;else switch(a){case"next":this.pageNumber++;break;case"prev":this.pageNumber--}this.pageNumber>this.pageCount&&(this.pageNumber=this.pageCount),this.pageNumber<1&&(this.pageNumber=1);var b=(this.pageNumber-1)*parseInt(this.pageSize),c=b+parseInt(this.pageSize);this.currentDatas=this.datas.slice(b,c),this.controls.number.text(this.pageNumber+"/"+this.pageCount),this.pageNumber>1?this.controls.prev.show():this.controls.prev.hide(),this.pageNumber<this.pageCount?this.controls.next.show():this.controls.next.hide(),this.onGotoPage&&this.onGotoPage(this.currentDatas)}},changeSelectedTorrentStatus:function(a,b,c){var d=this.control.torrentlist.find("input:checked"),e=new Array;a||(a="start");for(var f=0;f<d.length;f++)e.push(parseInt(d[f].id.replace("torrent-","")));if(e.length>0){var arguments={ids:e};switch(a){case"remove":arguments["delete-local-data"]=c.removeData;break;case"verify":if(1==e.length){if(transmission.torrents.all[e[0]].percentDone>0&&0==confirm(system.lang.toolbar.tip["recheck-confirm"]))return}else if(0==confirm(system.lang.toolbar.tip["recheck-confirm"]))return}b=$(b),b.attr("disabled",!0),transmission.exec({method:"torrent-"+a,arguments:arguments},function(a){b.attr("disabled",!1),system.reloadTorrentBaseInfos()}),this.torrentListChecked=!1}},addTorrentsToServer:function(a,b,c,d,e){var f=b-a.length,g=a.shift();if(!g)return this.showStatus(this.lang.system.status.queuefinish),this.getServerStatus(),void(e&&e());this.showStatus(this.lang.system.status.queue,b-f+1),transmission.addTorrentFromUrl(g,d,c,function(f){system.addTorrentsToServer(a,b,c,d,e)})},showStatus:function(a,b){if(!a)return void $("#status").hide();$("#status").show(),$("#status-msg").html(a),$.isNumeric(b)?$("#status-count").html(b).show():$("#status-count").hide()}};$(document).ready(function(){$.getScript(system.rootPath+"lang/default.js"),$.getScript(system.rootPath+"lang/_languages.js",function(){system.init(location.search.getQueryString("lang"))})});